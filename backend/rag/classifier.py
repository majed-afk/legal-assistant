"""
Query classifier for legal questions.
Classifies user questions to improve search relevance.
"""
import re

CATEGORY_KEYWORDS = {
    "خطبة": ["خطبة", "خاطب", "مخطوبة", "عدول عن الخطبة", "هدايا الخطبة"],
    "زواج": ["زواج", "عقد الزواج", "نكاح", "ولي", "شهود", "شروط الزواج", "أركان", "إيجاب", "قبول", "تعدد"],
    "مهر": ["مهر", "صداق", "مهر المثل", "مقدم", "مؤخر"],
    "طلاق": ["طلاق", "تطليق", "رجعي", "بائن", "مراجعة", "يمين الطلاق", "طلقة", "طلقات"],
    "خلع": ["خلع", "مخالعة", "عوض الخلع", "افتداء", "كراهة"],
    "فسخ": ["فسخ", "فسخ عقد", "عيب", "ضرر", "إيلاء", "غياب الزوج", "شقاق", "تحكيم"],
    "نفقة": ["نفقة", "إنفاق", "سكن", "كسوة", "نفقة الزوجة", "نفقة الأولاد", "نفقة الوالدين"],
    "حضانة": ["حضانة", "حاضن", "محضون", "أحقية", "سن الحضانة", "انتقال الحضانة"],
    "زيارة": ["زيارة", "رؤية", "استصحاب", "استزارة"],
    "نسب": ["نسب", "إثبات النسب", "نفي النسب", "إقرار", "لعان", "DNA"],
    "عدة": ["عدة", "عدة الطلاق", "عدة الوفاة", "عدة الحامل", "انقضاء العدة"],
    "وصاية": ["وصاية", "وصي", "قاصر", "قصر", "ناقص أهلية"],
    "ولاية": ["ولاية", "ولي", "عضل", "ولاية المال", "ولاية النفس"],
    "وصية": ["وصية", "موصي", "موصى له", "ثلث التركة", "إيصاء"],
    "إرث": ["إرث", "ميراث", "تركة", "ورثة", "فرض", "تعصيب", "حجب", "عول", "رد", "تخارج"],
    "لائحة": ["لائحة", "تنفيذية", "تنظيمية"],
    # نظام الإثبات
    "إثبات": ["إثبات", "بينة", "دليل", "أدلة", "برهان", "حجة"],
    "إقرار": ["إقرار", "اعتراف", "مقر", "أقر"],
    "استجواب": ["استجواب", "استجوب", "مستجوب"],
    "محررات": ["محرر", "محررات", "مستند", "مستندات", "وثيقة", "وثائق", "محرر رسمي", "محرر عادي", "سند"],
    "تزوير": ["تزوير", "مزور", "ادعاء بالتزوير", "تحقيق خطوط", "صحة محرر"],
    "دليل_رقمي": ["دليل رقمي", "إلكتروني", "رقمي", "سجل إلكتروني", "توقيع إلكتروني", "بريد إلكتروني", "وسائط رقمية"],
    "شهادة": ["شهادة", "شاهد", "شهود", "شهادة الشهود", "أداء الشهادة", "نصاب الشهادة"],
    "قرائن": ["قرينة", "قرائن", "أمر مقضي", "حجية", "افتراض"],
    "عرف": ["عرف", "عادة", "تعامل", "أعراف"],
    "يمين": ["يمين", "حلف", "نكول", "يمين حاسمة", "يمين متممة", "استحلاف"],
    "معاينة": ["معاينة", "انتقال", "إثبات حالة"],
    "خبرة": ["خبرة", "خبير", "تقرير خبير", "ندب خبير", "رأي فني"],
    # نظام المرافعات الشرعية
    "مرافعات": ["مرافعات", "مرافعة", "إجراءات", "محكمة", "قاضي", "دائرة"],
    "دعوى": ["دعوى", "رفع دعوى", "صحيفة دعوى", "قيد", "لائحة دعوى", "صحيفة"],
    "اختصاص": ["اختصاص", "اختصاص مكاني", "اختصاص نوعي", "محكمة مختصة", "ولاية المحكمة"],
    "تبليغ": ["تبليغ", "إعلان", "تبليغات", "محضر", "ورقة تبليغ"],
    "جلسة": ["جلسة", "جلسات", "حضور", "غياب", "تأجيل", "موعد جلسة"],
    "حكم": ["حكم", "منطوق", "أسباب الحكم", "تسبيب", "صدور الحكم", "نطق"],
    "اعتراض": ["اعتراض", "استئناف", "نقض", "التماس إعادة النظر", "طعن", "تمييز"],
    "تنفيذ": ["تنفيذ", "تنفيذ حكم", "محكمة التنفيذ", "سند تنفيذي"],
    "وكالة": ["وكالة", "وكيل", "توكيل", "محامي", "تفويض"],
    "دفوع": ["دفع", "دفوع", "عدم قبول", "بطلان", "تدخل", "إدخال"],
    "مستعجل": ["مستعجل", "قضاء مستعجل", "حالة مستعجلة", "أمر مؤقت", "حماية مؤقتة"],
    "إنهاءات": ["إنهاء", "إنهاءات", "ولاية", "حجر", "إذن", "إثبات وفاة"],
    # نظام المعاملات المدنية
    "عقد": ["عقد", "عقود", "تعاقد", "متعاقد", "إيجاب", "قبول", "بطلان العقد", "فسخ العقد", "إلزام"],
    "التزام": ["التزام", "التزامات", "دين", "دائن", "مدين", "تضامن", "كفالة", "ضمان"],
    "بيع": ["بيع", "مبيع", "بائع", "مشتري", "ثمن", "عقد بيع", "شراء"],
    "إيجار": ["إيجار", "مؤجر", "مستأجر", "أجرة", "إجارة", "عقد إيجار"],
    "مقاولة": ["مقاولة", "مقاول", "صاحب العمل", "إنجاز", "تنفيذ عمل"],
    "وكالة_مدنية": ["وكالة", "وكيل", "موكل", "توكيل", "تفويض"],
    "شركة": ["شركة", "شريك", "حصة", "ربح", "خسارة", "شراكة", "مضاربة"],
    "ملكية": ["ملكية", "مالك", "ملك", "تملك", "حق عيني", "نزع ملكية"],
    "شفعة": ["شفعة", "شفيع", "أخذ بالشفعة"],
    "تعويض": ["تعويض", "ضرر", "مسؤولية", "خطأ", "إضرار", "جبر ضرر", "تعويض عن ضرر"],
    "تقادم": ["تقادم", "مرور الزمن", "سقوط بالتقادم", "عدم سماع الدعوى"],
    "حيازة": ["حيازة", "حائز", "وضع يد"],
    "ارتفاق": ["ارتفاق", "حق مرور", "مجرى", "مسيل", "حق المرور"],
    "انتفاع": ["انتفاع", "حق الانتفاع", "منتفع"],
    "رهن": ["رهن", "مرهون", "راهن", "مرتهن", "ضمان عيني"],
    "هبة": ["هبة", "واهب", "موهوب", "تبرع"],
    "قرض": ["قرض", "مقرض", "مقترض", "اقتراض"],
    "صلح": ["صلح", "مصالحة", "تسوية"],
    "إيداع": ["إيداع", "وديعة", "مودع", "أمانة"],
    "إعارة": ["إعارة", "معير", "مستعير", "عارية"],
}

INTENT_PATTERNS = {
    "استشارة": ["ما حكم", "هل يجوز", "هل يحق", "ما هي حقوق", "ايش حقوقي", "وش الحكم"],
    "صياغة": ["صياغة", "اكتب", "مذكرة", "لائحة دعوى", "نموذج"],
    "تحليل": ["تحليل", "قوة الموقف", "فرص", "احتمال"],
    "معلومة": ["ما هو", "ما هي", "عرّف", "كم", "متى", "أين", "شرح"],
    "مهلة": ["مهلة", "مدة", "موعد", "متى ينتهي", "كم يوم", "كم شهر"],
}


def classify_query(question: str) -> dict:
    """Classify a legal question."""
    question_lower = question.strip()

    # Detect category
    category = "عام"
    category_scores = {}
    for cat, keywords in CATEGORY_KEYWORDS.items():
        score = sum(1 for kw in keywords if kw in question_lower)
        if score > 0:
            category_scores[cat] = score

    if category_scores:
        category = max(category_scores, key=category_scores.get)

    # Detect intent
    intent = "استشارة"
    for int_type, patterns in INTENT_PATTERNS.items():
        if any(p in question_lower for p in patterns):
            intent = int_type
            break

    # Check urgency
    urgency = "عاجل" if any(w in question_lower for w in ["عاجل", "فوري", "طوارئ", "الآن"]) else "عادي"

    # Check if deadline related
    needs_deadline = any(w in question_lower for w in ["مهلة", "مدة", "عدة", "موعد", "متى", "أيام", "أشهر"])

    return {
        "category": category,
        "intent": intent,
        "urgency": urgency,
        "needs_deadline_check": needs_deadline,
        "all_categories": list(category_scores.keys()) if category_scores else ["عام"],
    }
