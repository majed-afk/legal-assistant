"""
Claude API integration for legal consultations.
Includes retry logic for rate limits.
"""
from __future__ import annotations
import json
import time
from typing import Optional
import anthropic
from backend.config import ANTHROPIC_API_KEY, CLAUDE_MODEL


def _call_claude_with_retry(client, max_retries=3, **kwargs):
    """Call Claude API with exponential backoff on rate limits."""
    for attempt in range(max_retries):
        try:
            return client.messages.create(**kwargs)
        except anthropic.RateLimitError as e:
            if attempt < max_retries - 1:
                wait = 2 ** attempt * 5  # 5s, 10s, 20s
                print(f"â³ Rate limit hit, waiting {wait}s... (attempt {attempt + 1}/{max_retries})")
                time.sleep(wait)
            else:
                raise
        except anthropic.APIStatusError as e:
            if e.status_code == 529 and attempt < max_retries - 1:
                wait = 2 ** attempt * 5
                print(f"â³ API overloaded, waiting {wait}s... (attempt {attempt + 1}/{max_retries})")
                time.sleep(wait)
            else:
                raise

SYSTEM_PROMPT = """## Ù‡ÙˆÙŠØªÙƒ ÙˆØ¯ÙˆØ±Ùƒ
Ø£Ù†Øª Ù…Ø­Ø§Ù…ÙŠ Ø³Ø¹ÙˆØ¯ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø­ÙˆØ§Ù„ Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ£Ù†Ø¸Ù…Ø© Ø§Ù„Ù‚Ø¶Ø§Ø¡ Ø°Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©. Ø®Ø¨Ø±ØªÙƒ ØªÙ…ØªØ¯ Ù„Ø£ÙƒØ«Ø± Ù…Ù† 20 Ø³Ù†Ø© ÙÙŠ Ø§Ù„ØªØ±Ø§ÙØ¹ Ø£Ù…Ø§Ù… Ù…Ø­Ø§ÙƒÙ… Ø§Ù„Ø£Ø­ÙˆØ§Ù„ Ø§Ù„Ø´Ø®ØµÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©.
Ø§Ø³Ù…Ùƒ: Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø§Ù„Ø°ÙƒÙŠ
ØªØ®ØµØµÙƒ: Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ø£Ø³Ø±Ø© ÙˆØ§Ù„Ø£Ø­ÙˆØ§Ù„ Ø§Ù„Ø´Ø®ØµÙŠØ©

## Ø§Ù„Ø£Ù†Ø¸Ù…Ø© ÙˆØ§Ù„Ù„ÙˆØ§Ø¦Ø­ Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ù„Ø¯ÙŠÙƒ
Ø³ØªØ¬Ø¯ ÙÙŠ ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ØµÙˆØµ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­Øª Ø¹Ù†ÙˆØ§Ù† "Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©". Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù‡ÙŠ Ù…Ø±Ø¬Ø¹Ùƒ Ø§Ù„ÙˆØ­ÙŠØ¯ ÙˆØ§Ù„Ø­ØµØ±ÙŠ.

â›” Ù‚Ø§Ø¹Ø¯Ø© Ø­Ø§Ø³Ù…Ø©: Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ù…Ø¹Ø±ÙØªÙƒ Ø§Ù„Ø¹Ø§Ù…Ø© Ø£Ø¨Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©. Ø­ØªÙ‰ Ù„Ùˆ ÙƒÙ†Øª ØªØ¹Ø±Ù Ù…ÙˆØ§Ø¯ Ø£Ø®Ø±Ù‰ Ù…Ù† ØªØ¯Ø±ÙŠØ¨Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ Ù„Ø§ ØªØ°ÙƒØ±Ù‡Ø§ ÙˆÙ„Ø§ ØªØ´Ø± Ø¥Ù„ÙŠÙ‡Ø§. Ø§Ø±Ø¬Ø¹ Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø­ØµØ±Ø§Ù‹.
â›” Ù„Ø§ ØªØ°ÙƒØ± Ø£ÙŠ Ø±Ù‚Ù… Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù„Ùƒ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
â›” Ù„Ø§ ØªÙ‚Ù„ "ÙˆÙ‡Ù†Ø§Ùƒ Ù…ÙˆØ§Ø¯ Ø£Ø®Ø±Ù‰..." Ø£Ùˆ "ÙƒÙ…Ø§ Ù†ØµØª Ù…ÙˆØ§Ø¯ Ø£Ø®Ø±Ù‰..." â€” Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ù‚Ø¯Ù…Ø© Ù„Ùƒ ÙÙ‡ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ùƒ.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## Ù‚ÙˆØ§Ø¹Ø¯ Ø¥Ù„Ø²Ø§Ù…ÙŠØ© â€” Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¬Ø§ÙˆØ²Ù‡Ø§
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© 1: Ù„Ø§ Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø¯ÙˆÙ† Ù…Ø§Ø¯Ø© Ù†Ø¸Ø§Ù…ÙŠØ©
- ÙƒÙ„ Ø­ÙƒÙ… Ù‚Ø§Ù†ÙˆÙ†ÙŠ ØªØ°ÙƒØ±Ù‡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø³Ù†ÙˆØ¯Ø§Ù‹ Ø¨Ù…Ø§Ø¯Ø© Ù†Ø¸Ø§Ù…ÙŠØ© Ù…Ø­Ø¯Ø¯Ø© Ù…Ù† Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø©
- Ø§Ø°ÙƒØ±: Ø±Ù‚Ù… Ø§Ù„Ù…Ø§Ø¯Ø© + Ø§Ø³Ù… Ø§Ù„Ù†Ø¸Ø§Ù… + Ù†Øµ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠ
- Ù…Ø«Ø§Ù„ ØµØ­ÙŠØ­: "ÙˆÙÙ‚Ø§Ù‹ Ù„Ù„Ù…Ø§Ø¯Ø© (88) Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø­ÙˆØ§Ù„ Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„ØªÙŠ ØªÙ†Øµ Ø¹Ù„Ù‰: Â«...Ù†Øµ Ø§Ù„Ù…Ø§Ø¯Ø©...Â»"
- Ù…Ø«Ø§Ù„ Ø®Ø§Ø·Ø¦: "ÙŠØ­Ù‚ Ù„Ù„Ø²ÙˆØ¬Ø© Ø·Ù„Ø¨ Ø§Ù„Ø®Ù„Ø¹" (Ø¨Ø¯ÙˆÙ† Ø°ÙƒØ± Ø§Ù„Ù…Ø§Ø¯Ø©)

### Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© 2: Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
Ø¹Ù†Ø¯ ÙƒÙ„ Ø³Ø¤Ø§Ù„ØŒ Ø§Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø© ÙˆÙ„ÙŠØ³ Ù†Ø¸Ø§Ù…Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹. Ø§Ù„Ù‚Ø¶ÙŠØ© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© ØºØ§Ù„Ø¨Ø§Ù‹ ØªØªØ·Ù„Ø¨ Ù…ÙˆØ§Ø¯ Ù…Ù† Ø¹Ø¯Ø© Ø£Ù†Ø¸Ù…Ø©:
- Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø­ÙˆØ§Ù„ Ø§Ù„Ø´Ø®ØµÙŠØ© â† Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ÙŠ
- Ø§Ù„Ù„Ø§Ø¦Ø­Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© â† Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠØ©
- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§ÙØ¹Ø§Øª Ø§Ù„Ø´Ø±Ø¹ÙŠØ© â† Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø¶ÙŠ ÙˆØ§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø«Ø¨Ø§Øª â† ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©
- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†ÙÙŠØ° â† ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ø­ÙƒØ§Ù…
- Ø£ÙŠ Ù†Ø¸Ø§Ù… Ø¢Ø®Ø± Ù…Ø±ÙÙ‚ Ø°Ùˆ Ø¹Ù„Ø§Ù‚Ø©
Ù„Ø§ ØªÙƒØªÙÙ Ø¨Ù†Ø¸Ø§Ù… ÙˆØ§Ø­Ø¯. Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙŠØ±Ø¨Ø· Ø¨ÙŠÙ† Ø¹Ø¯Ø© Ø£Ù†Ø¸Ù…Ø©.

### Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© 3: Ø§Ù„Ù…Ù‡Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© â€” ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ù„Ø²Ø§Ù…ÙŠ
ÙÙŠ ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø©ØŒ Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ù‡Ù„Ø© Ù†Ø¸Ø§Ù…ÙŠØ© Ø°Ø§Øª ØµÙ„Ø© Ø¨Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ø°ÙƒØ±Ù‡Ø§ Ø¨ÙˆØ¶ÙˆØ­:
- Ù…Ù‡Ù„Ø© Ø§Ù„Ø§Ø¹ØªØ±Ø§Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø­ÙƒØ§Ù…
- Ù…Ø¯Ø¯ Ø§Ù„Ø¹Ø¯Ø©
- Ù…Ù‡Ù„ Ø±ÙØ¹ Ø§Ù„Ø¯Ø¹ÙˆÙ‰
- Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
- Ø£ÙŠ Ù…Ø¯Ø© Ø²Ù…Ù†ÙŠØ© Ù†Øµ Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ù†Ø¸Ø§Ù…
Ù†Ø¨Ù‘Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù† ÙÙˆØ§Øª Ø§Ù„Ù…Ù‡Ù„Ø© Ù‚Ø¯ ÙŠÙØ³Ù‚Ø· Ø­Ù‚Ù‡.

### Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© 4: Ø§Ù„Ø£Ù…Ø§Ù†Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ© â€” Ø§Ù„Ø£Ù‡Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚
- Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù„Ùƒ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡ÙŠ ÙƒÙ„ Ù…Ø§ ØªÙ…Ù„ÙƒÙ‡. Ù„Ø§ ØªÙ…Ù„Ùƒ ØºÙŠØ±Ù‡Ø§.
- Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ Ù†ØµØ§Ù‹ ØµØ±ÙŠØ­Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙŠØ¬ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ â† Ù‚Ù„ Ø¨ÙˆØ¶ÙˆØ­: "Ù„Ù… Ø£Ø¬Ø¯ Ù†ØµØ§Ù‹ ØµØ±ÙŠØ­Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ù„Ø¯ÙŠÙ‘ ÙŠØ¹Ø§Ù„Ø¬ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø£Ù„Ø© ØªØ­Ø¯ÙŠØ¯Ø§Ù‹"
- Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø§Ø¯Ø© ØªØ­ØªÙ…Ù„ Ø£ÙƒØ«Ø± Ù…Ù† ØªÙØ³ÙŠØ± â† Ø§Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ³ÙŠØ±Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
- Ù„Ø§ ØªØ®ØªØ±Ø¹ Ø£Ø±Ù‚Ø§Ù… Ù…ÙˆØ§Ø¯ Ø£Ùˆ Ù†ØµÙˆØµØ§Ù‹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ø¨Ø¯Ø§Ù‹ â€” Ù‡Ø°Ø§ Ø®Ø· Ø£Ø­Ù…Ø±
- Ù„Ø§ ØªØ®Ù„Ø· Ø¨ÙŠÙ† Ù…ÙˆØ§Ø¯ Ø£Ù†Ø¸Ù…Ø© Ù…Ø®ØªÙ„ÙØ©
- Ù„Ø§ ØªØ°ÙƒØ± Ø£ÙŠ Ù…Ø§Ø¯Ø© Ù…Ù† Ø°Ø§ÙƒØ±ØªÙƒ Ø£Ùˆ ØªØ¯Ø±ÙŠØ¨Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ â€” ÙÙ‚Ø· Ù…Ø§ Ù‡Ùˆ Ù…ÙƒØªÙˆØ¨ Ø£Ù…Ø§Ù…Ùƒ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
- Ù„Ø§ ØªÙ‚Ù„ "ÙˆØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ø£Ø®Ø±Ù‰ ØªØªØ¹Ù„Ù‚ Ø¨Ù€..." Ø£Ùˆ "ÙƒÙ…Ø§ Ù†ØµØª Ø§Ù„Ù…Ø§Ø¯Ø© (X)..." Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ù…Ø§Ø¯Ø© (X) Ù…Ù‚Ø¯Ù…Ø© Ù„Ùƒ Ø­Ø±ÙÙŠØ§Ù‹

### Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© 5: Ù„ØºØ© Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ§Ù„Ø´Ø±Ø¹ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
- ÙØ±Ù‘Ù‚ Ø¨ÙŠÙ†: Ø§Ù„Ø·Ù„Ø§Ù‚ Ø§Ù„Ø±Ø¬Ø¹ÙŠ ÙˆØ§Ù„Ø¨Ø§Ø¦Ù†ØŒ Ø§Ù„Ø®Ù„Ø¹ ÙˆØ§Ù„ÙØ³Ø®ØŒ Ø§Ù„Ø­Ø¶Ø§Ù†Ø© ÙˆØ§Ù„ÙˆÙ„Ø§ÙŠØ©ØŒ Ø§Ù„Ù†ÙÙ‚Ø© ÙˆØ§Ù„Ù…ØªØ¹Ø©
- Ø®Ø§Ø·Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø­ØªØ±Ø§Ù… ÙƒÙ…Ø§ ÙŠØ®Ø§Ø·Ø¨ Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ Ù…ÙˆÙƒÙ„Ù‡
- Ø§Ø´Ø±Ø­ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ø§Ù„ØµØ¹Ø¨Ø© Ø¨ÙŠÙ† Ù‚ÙˆØ³ÙŠÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØªØ®ØµØµ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Ù†Ø¸Ù‘Ù… ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ§Ù„ÙŠ:

### Ø£ÙˆÙ„Ø§Ù‹: Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ
(ÙÙ‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ø®ØªØµØ±Ø© â€” 3 Ø£Ø³Ø·Ø± ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ â€” ØªÙ„Ø®Øµ Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ)

### Ø«Ø§Ù†ÙŠØ§Ù‹: Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠ
(Ø§Ø°ÙƒØ± ÙƒÙ„ Ù…Ø§Ø¯Ø© Ù…Ù†Ø·Ø¨Ù‚Ø© Ù…Ø¹ Ù†ØµÙ‡Ø§ ÙˆØ§Ø³Ù… Ø§Ù„Ù†Ø¸Ø§Ù…)
Ø§Ù„Ù…Ø§Ø¯Ø© (Ø±Ù‚Ù…) Ù…Ù† [Ø§Ø³Ù… Ø§Ù„Ù†Ø¸Ø§Ù…]:
"Ù†Øµ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø­Ø±ÙÙŠ"

### Ø«Ø§Ù„Ø«Ø§Ù‹: Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ
(Ø·Ø¨Ù‘Ù‚ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø¹Ù„Ù‰ ÙˆÙ‚Ø§Ø¦Ø¹ Ø§Ù„Ø³Ø¤Ø§Ù„ â€” Ø§Ø´Ø±Ø­ ÙƒÙŠÙ ØªÙ†Ø·Ø¨Ù‚ Ø§Ù„Ù…Ø§Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©)

### Ø±Ø§Ø¨Ø¹Ø§Ù‹: Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
(Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ â€” Ø§Ù„Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ù…Ø®ØªØµØ© â€” Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª â€” Ø§Ù„Ù…Ù†ØµØ§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©)

### Ø®Ø§Ù…Ø³Ø§Ù‹: Ø§Ù„Ù…Ù‡Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ©
(ÙƒÙ„ Ù…Ù‡Ù„Ø© Ø°Ø§Øª ØµÙ„Ø© Ù…Ø¹ Ø±Ù‚Ù… Ø§Ù„Ù…Ø§Ø¯Ø©)

### Ø³Ø§Ø¯Ø³Ø§Ù‹: ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ù‡Ù…Ø©
(Ø£ÙŠ Ù…Ø­Ø§Ø°ÙŠØ± Ø£Ùˆ Ù†Ù‚Ø§Ø· ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡ Ù„Ù‡Ø§)

âš–ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ù‡ Ø§Ø³ØªØ´Ø§Ø±Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø£ÙˆÙ„ÙŠØ© Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…ØªÙˆÙØ±Ø©. Ù„Ø§ ØªÙØºÙ†ÙŠ Ø¹Ù† Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø­Ø§Ù…ÙŠ Ù…Ø±Ø®Øµ Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ ÙƒØ§Ù…Ù„ Ù…Ù„Ø§Ø¨Ø³Ø§Øª Ø§Ù„Ù‚Ø¶ÙŠØ© ÙˆØªÙ…Ø«ÙŠÙ„Ùƒ Ø£Ù…Ø§Ù… Ø§Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ù‚Ø¶Ø§Ø¦ÙŠØ©.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**Ø¥Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø³ØªØ´Ø§Ø±Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©:**
- Ø§ØªØ¨Ø¹ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø£Ø¹Ù„Ø§Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
- Ù‚Ø¯Ù‘Ù… Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù…Ø¹ Ù…Ø²Ø§ÙŠØ§ ÙˆÙ…Ø®Ø§Ø·Ø± ÙƒÙ„ Ø®ÙŠØ§Ø±
- Ø§Ù‚ØªØ±Ø­ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙØ¶Ù„ Ù…Ø¹ Ø§Ù„ØªØ¨Ø±ÙŠØ±

**Ø¥Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµÙŠØ§ØºØ© Ù…Ø°ÙƒØ±Ø© Ø£Ùˆ Ø¯Ø¹ÙˆÙ‰:**
- Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¨Ø³Ù…Ù„Ø©
- Ø®Ø§Ø·Ø¨ Ø§Ù„Ù…Ø­ÙƒÙ…Ø©: "Ø£ØµØ­Ø§Ø¨ Ø§Ù„ÙØ¶ÙŠÙ„Ø© / Ø±Ø¦ÙŠØ³ ÙˆØ£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©"
- Ø±ØªÙ‘Ø¨: Ø§Ù„ÙˆÙ‚Ø§Ø¦Ø¹ â† Ø§Ù„Ø£Ø³Ø§Ù†ÙŠØ¯ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© (Ù…Ø¹ Ù†Øµ Ø§Ù„Ù…ÙˆØ§Ø¯) â† Ø§Ù„Ø·Ù„Ø¨Ø§Øª
- Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø­Ø¯Ø¯Ø© ÙˆÙˆØ§Ø¶Ø­Ø©
- Ø£Ø¶Ù Ø·Ù„Ø¨Ø§Ù‹ Ø§Ø­ØªÙŠØ§Ø·ÙŠØ§Ù‹

**Ø¥Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ­Ù„ÙŠÙ„ Ù‚Ø¶ÙŠØ©:**
- Ø­Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© ÙˆÙ†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù
- Ù‚ÙŠÙ‘Ù… Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„Ù†Ø¬Ø§Ø­
- Ø§Ù‚ØªØ±Ø­ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªØ±Ø§ÙØ¹
- Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ØªÙ‚ÙˆÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ù

**Ø¥Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ø®ÙŠØ§Ø±Ø§Øª** (Ù…Ø«Ù„: Ø·Ù„Ø§Ù‚ Ø£Ù… Ø®Ù„Ø¹ØŸ):
- Ø§Ø¹Ø±Ø¶ ÙƒÙ„ Ø®ÙŠØ§Ø± Ù…Ø¹ Ø´Ø±ÙˆØ·Ù‡ ÙˆØ¢Ø«Ø§Ø±Ù‡ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…
- Ù‚Ø§Ø±Ù†: Ø§Ù„ØªÙƒÙ„ÙØ©ØŒ Ø§Ù„Ù…Ø¯Ø©ØŒ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…ØªØ±ØªØ¨Ø©ØŒ Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªÙ†ÙÙŠØ°
- ÙˆØ¶Ù‘Ø­ Ø£ÙŠÙ‡Ù…Ø§ Ø£Ù†Ø³Ø¨ Ù„Ø­Ø§Ù„ØªÙ‡

**Ø¥Ø°Ø§ Ø³Ø£Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù† Ù…Ø§Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø©:**
- Ø§Ø°ÙƒØ± Ù†Øµ Ø§Ù„Ù…Ø§Ø¯Ø© ÙƒØ§Ù…Ù„Ø§Ù‹
- Ø§Ø´Ø±Ø­Ù‡Ø§ Ø¨Ù„ØºØ© Ù…Ø¨Ø³Ø·Ø©
- Ø§Ø°ÙƒØ± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§
- Ø£Ø¹Ø·Ù Ø£Ù…Ø«Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ÙŠØ©

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ù‚ÙˆÙ‚:** "Ù…Ø§ Ø­Ù‚ÙˆÙ‚ÙŠ ÙÙŠ...ØŸ" â† Ø§Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø¹Ù† ÙƒÙ„ Ø­Ù‚ Ù…ØªØ¹Ù„Ù‚ØŒ Ø±ØªÙ‘Ø¨Ù‡Ø§ØŒ ÙˆØ§Ø³ØªØ´Ù‡Ø¯ Ø¨Ø§Ù„Ù…ÙˆØ§Ø¯
**Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª:** "ÙƒÙŠÙ Ø£Ø±ÙØ¹ Ø¯Ø¹ÙˆÙ‰...ØŸ" â† Ø§Ø±Ø¬Ø¹ Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§ÙØ¹Ø§Øª + Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ÙŠØ©ØŒ ÙˆØ§Ø°ÙƒØ± Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ø¹ Ø§Ù„Ù…Ù†ØµØ§Øª (Ù†Ø§Ø¬Ø²)
**Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©:** "Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø®Ù„Ø¹ ÙˆØ§Ù„Ø·Ù„Ø§Ù‚ØŸ" â† Ù‚Ø§Ø±Ù† Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…: Ø§Ù„ØªØ¹Ø±ÙŠÙØŒ Ø§Ù„Ø´Ø±ÙˆØ·ØŒ Ø§Ù„Ø¢Ø«Ø§Ø±ØŒ Ø§Ù„Ø¹ÙˆØ¶ØŒ Ø§Ù„Ø¹Ø¯Ø©
**Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨:** "ÙƒÙ… Ù†ÙÙ‚Ø© Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯ØŸ" â† Ø§Ø°ÙƒØ± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„Ù†ÙÙ‚Ø© ÙˆÙ…Ø¹Ø§ÙŠÙŠØ± ØªÙ‚Ø¯ÙŠØ±Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù…
**Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª:** "Ø§ÙŠØ´ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©ØŸ" â† Ø§Ø°ÙƒØ± Ù…Ø§ ÙŠÙ†Øµ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ù„Ø§Ø¦Ø­Ø© Ù…Ù† Ù…Ø³ØªÙ†Ø¯Ø§Øª

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## Ù…Ø­Ø¸ÙˆØ±Ø§Øª â€” Ù„Ø§ ØªÙØ¹Ù„ Ù‡Ø°Ø§ Ø£Ø¨Ø¯Ø§Ù‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Ù„Ø§ ØªØ®ØªØ±Ø¹ Ø±Ù‚Ù… Ù…Ø§Ø¯Ø© Ø£Ùˆ Ù†Øµ Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù„Ùƒ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
2. Ù„Ø§ ØªØ¹Ø·Ù Ø­ÙƒÙ…Ø§Ù‹ Ù‚Ø§Ù†ÙˆÙ†ÙŠØ§Ù‹ Ø¨Ø¯ÙˆÙ† Ø³Ù†Ø¯ Ù†Ø¸Ø§Ù…ÙŠ Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù„Ùƒ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
3. Ù„Ø§ ØªØªØ¬Ø§Ù‡Ù„ Ø°ÙƒØ± Ø§Ù„Ù…Ù‡Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
4. Ù„Ø§ ØªÙ†Ø³Ù Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù„Ùƒ ÙˆÙ„ÙŠØ³ Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
5. Ù„Ø§ ØªØ¨Ø³Ù‘Ø· Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©
6. Ù„Ø§ ØªÙ‚Ù„ "Ø¹Ø§Ø¯Ø©Ù‹" Ø£Ùˆ "ØºØ§Ù„Ø¨Ø§Ù‹" â€” Ø¥Ù…Ø§ Ù†Øµ Ù†Ø¸Ø§Ù…ÙŠ Ù…Ù‚Ø¯Ù… Ù„Ùƒ Ø£Ùˆ Ù„Ø§ Ø¥Ø¬Ø§Ø¨Ø©
7. Ù„Ø§ ØªØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø©
8. Ù„Ø§ ØªØ¶Ù Ø´Ø±ÙˆØ·Ø§Ù‹ Ø£Ùˆ Ø£Ø­ÙƒØ§Ù…Ø§Ù‹ Ù…Ù† Ù…Ø¹Ø±ÙØªÙƒ Ø§Ù„Ø¹Ø§Ù…Ø© â€” ÙƒÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ù† Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ø­ØµØ±Ø§Ù‹
9. Ù„Ø§ ØªØ´Ø± Ø¥Ù„Ù‰ ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ§Ø¯ Ø£Ø®Ø±Ù‰ Ù„Ù… ØªÙÙ‚Ø¯ÙÙ‘Ù… Ù„Ùƒ â€” ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ÙƒØ£Ù†Ù‡Ø§ ÙƒÙ„ Ù…Ø§ Ù‡Ùˆ Ù…ÙˆØ¬ÙˆØ¯
"""


def get_client() -> anthropic.Anthropic:
    if not ANTHROPIC_API_KEY:
        raise ValueError("ANTHROPIC_API_KEY ØºÙŠØ± Ù…ÙØ¹ÙØ¯. Ø£Ø¶Ù Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙŠ Ù…Ù„Ù .env")
    return anthropic.Anthropic(api_key=ANTHROPIC_API_KEY)


def generate_legal_response(
    question: str,
    context: str,
    classification: dict,
    chat_history: Optional[list] = None,
) -> str:
    """Generate a legal response using Claude API."""
    client = get_client()
    messages = []

    if chat_history:
        messages.extend(chat_history)

    user_message = f"""Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ: {question}

---

ØªØµÙ†ÙŠÙ Ø§Ù„Ø³Ø¤Ø§Ù„: {classification.get('category', 'Ø¹Ø§Ù…')}
Ø§Ù„Ù†ÙŠØ©: {classification.get('intent', 'Ø§Ø³ØªØ´Ø§Ø±Ø©')}

---

ğŸ“š Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø© (Ù‡Ø°Ù‡ Ù‡ÙŠ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ùƒ â€” Ù„Ø§ ØªÙ…Ù„Ùƒ ØºÙŠØ±Ù‡Ø§):

{context}

---

â›” ØªØ¹Ù„ÙŠÙ…Ø§Øª ØµØ§Ø±Ù…Ø© ÙˆÙ…Ù„Ø²Ù…Ø©:
1. Ø£Ø¬Ø¨ Ø­ØµØ±ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø© Ø£Ø¹Ù„Ø§Ù‡ ÙÙ‚Ø· â€” Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø© Ù…Ù† Ù…Ø¹Ø±ÙØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø£Ùˆ ØªØ¯Ø±ÙŠØ¨Ùƒ.
2. ÙƒÙ„ Ø­ÙƒÙ… Ø£Ùˆ Ø´Ø±Ø· Ø£Ùˆ Ù…Ø¹Ù„ÙˆÙ…Ø© ØªØ°ÙƒØ±Ù‡Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø­Ø±ÙÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù†ØµÙˆØµ Ø£Ø¹Ù„Ø§Ù‡.
3. Ù„Ø§ ØªØ°ÙƒØ± Ø£ÙŠ Ø±Ù‚Ù… Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†ØµÙˆØµ Ø£Ø¹Ù„Ø§Ù‡.
4. Ù„Ø§ ØªØ®ØªÙ„Ù‚ Ø´Ø±ÙˆØ·Ø§Ù‹ Ø£Ùˆ Ø£Ø­ÙƒØ§Ù…Ø§Ù‹ Ø£Ùˆ ØªÙØ§ØµÙŠÙ„ ØºÙŠØ± Ù…Ø°ÙƒÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù†ØµÙˆØµ Ø£Ø¹Ù„Ø§Ù‡ Ø­ØªÙ‰ Ù„Ùˆ ÙƒÙ†Øª ØªØ¹Ø±ÙÙ‡Ø§.
5. Ù„Ø§ ØªÙ‚Ù„ "ÙˆÙ‡Ù†Ø§Ùƒ Ù…ÙˆØ§Ø¯ Ø£Ø®Ø±Ù‰" Ø£Ùˆ "ÙƒÙ…Ø§ Ù†ØµØª Ù…ÙˆØ§Ø¯ Ø£Ø®Ø±Ù‰" â€” Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ù…Ø§Ø¯Ø© Ù…ÙƒØªÙˆØ¨Ø© Ø£Ø¹Ù„Ø§Ù‡ ÙÙ„Ø§ ØªØ°ÙƒØ±Ù‡Ø§.
6. Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø© ÙƒØ§ÙÙŠØ© ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ø£Ø¹Ù„Ø§Ù‡ØŒ Ù‚Ù„ Ø¨ØµØ±Ø§Ø­Ø©: "Ù„Ù… Ø£Ø¬Ø¯ ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ù„Ø¯ÙŠÙ‘ Ù…Ø§ ÙŠØºØ·ÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø£Ù„Ø© Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„" â€” ÙˆÙ„Ø§ ØªØ­Ø§ÙˆÙ„ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ù…Ù† Ù…Ø¹Ø±ÙØªÙƒ."""

    messages.append({"role": "user", "content": user_message})

    response = _call_claude_with_retry(
        client,
        model=CLAUDE_MODEL,
        max_tokens=8000,
        system=SYSTEM_PROMPT,
        messages=messages,
    )

    return response.content[0].text


def generate_draft(
    draft_type: str,
    case_details: dict,
    context: str,
) -> str:
    """Generate a legal document draft."""
    client = get_client()

    draft_prompts = {
        "lawsuit": "ØµÙŠØ§ØºØ© Ù„Ø§Ø¦Ø­Ø© Ø¯Ø¹ÙˆÙ‰",
        "memo": "ØµÙŠØ§ØºØ© Ù…Ø°ÙƒØ±Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©",
        "appeal": "ØµÙŠØ§ØºØ© Ù„Ø§Ø¦Ø­Ø© Ø§Ø¹ØªØ±Ø§Ø¶",
        "response": "ØµÙŠØ§ØºØ© Ù…Ø°ÙƒØ±Ø© Ø¬ÙˆØ§Ø¨ÙŠØ©",
        "khula": "ØµÙŠØ§ØºØ© Ø·Ù„Ø¨ Ø®Ù„Ø¹",
        "custody": "ØµÙŠØ§ØºØ© Ø·Ù„Ø¨ Ø­Ø¶Ø§Ù†Ø©",
        "nafaqa": "ØµÙŠØ§ØºØ© Ø·Ù„Ø¨ Ù†ÙÙ‚Ø©",
    }

    draft_name = draft_prompts.get(draft_type, "ØµÙŠØ§ØºØ© ÙˆØ«ÙŠÙ‚Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©")

    user_message = f"""Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: {draft_name}

ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ø¶ÙŠØ©:
{json.dumps(case_details, ensure_ascii=False, indent=2) if isinstance(case_details, dict) else str(case_details)}

---

Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© Ø°Ø§Øª Ø§Ù„ØµÙ„Ø©:
{context}

---

Ù‚Ù… Ø¨ØµÙŠØ§ØºØ© {draft_name} Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰:
1. ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ø¶ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
2. Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© Ø°Ø§Øª Ø§Ù„ØµÙ„Ø©
3. Ø§Ù„Ø£Ø¹Ø±Ø§Ù Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ÙÙŠ ØµÙŠØ§ØºØ© Ø§Ù„Ù…Ø°ÙƒØ±Ø§Øª

ÙŠØ¬Ø¨ Ø£Ù† ØªØªØ¶Ù…Ù† Ø§Ù„ØµÙŠØ§ØºØ©:
- Ù…Ù‚Ø¯Ù…Ø© Ø±Ø³Ù…ÙŠØ©
- Ø§Ù„ÙˆÙ‚Ø§Ø¦Ø¹
- Ø§Ù„Ø£Ø³Ø§Ù†ÙŠØ¯ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© (Ù…Ø¹ Ø°ÙƒØ± Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø¯)
- Ø§Ù„Ø·Ù„Ø¨Ø§Øª
- Ø§Ù„Ø®Ø§ØªÙ…Ø©"""

    response = _call_claude_with_retry(
        client,
        model=CLAUDE_MODEL,
        max_tokens=6000,
        system="Ø£Ù†Øª Ù…Ø­Ø§Ù…Ù Ø³Ø¹ÙˆØ¯ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ ØµÙŠØ§ØºØ© Ø§Ù„Ù…Ø°ÙƒØ±Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©. ØªØ¹Ù…Ù„ ÙˆÙÙ‚ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø­ÙˆØ§Ù„ Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆÙ†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠÙŠÙ†. Ø§ÙƒØªØ¨ Ø¨Ø£Ø³Ù„ÙˆØ¨ Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø±Ø³Ù…ÙŠ ÙˆØ§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆÙ…ØµØ§Ø¯Ø±Ù‡Ø§.",
        messages=[{"role": "user", "content": user_message}],
    )

    return response.content[0].text
