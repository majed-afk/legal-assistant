"""
Parse the clean official text of نظام الأحوال الشخصية into structured articles.
Outputs a JSON file with each article's number, text, chapter, section, and topic.
"""
import json
import re
import sys

RAW_TEXT_PATH = "/Users/majedalkhudhayr/Desktop/المحامي/backend/data/ahwal_clean_raw.txt"
OUTPUT_PATH = "/Users/majedalkhudhayr/Desktop/المحامي/backend/data/ahwal_clean_articles.json"
EXISTING_PATH = "/Users/majedalkhudhayr/Desktop/المحامي/backend/data/articles.json"

# Arabic number words to digits mapping
ARABIC_ORDINALS = {
    "الأولى": 1, "الثانية": 2, "الثالثة": 3, "الرابعة": 4, "الخامسة": 5,
    "السادسة": 6, "السابعة": 7, "الثامنة": 8, "التاسعة": 9, "العاشرة": 10,
    "الحادية عشرة": 11, "الثانية عشرة": 12, "الثالثة عشرة": 13, "الرابعة عشرة": 14,
    "الخامسة عشرة": 15, "السادسة عشرة": 16, "السابعة عشرة": 17, "الثامنة عشرة": 18,
    "التاسعة عشرة": 19, "العشرون": 20, "العشرين": 20,
    "الحادية والعشرون": 21, "الحادية والعشرين": 21,
    "الثانية والعشرون": 22, "الثانية والعشرين": 22,
    "الثالثة والعشرون": 23, "الثالثة والعشرين": 23,
    "الرابعة والعشرون": 24, "الرابعة والعشرين": 24,
    "الخامسة والعشرون": 25, "الخامسة والعشرين": 25,
    "السادسة والعشرون": 26, "السادسة والعشرين": 26,
    "السابعة والعشرون": 27, "السابعة والعشرين": 27,
    "الثامنة والعشرون": 28, "الثامنة والعشرين": 28,
    "التاسعة والعشرون": 29, "التاسعة والعشرين": 29,
    "الثلاثون": 30, "الثلاثين": 30,
    "الحادية والثلاثون": 31, "الحادية والثلاثين": 31,
    "الثانية والثلاثون": 32, "الثانية والثلاثين": 32,
    "الثالثة والثلاثون": 33, "الثالثة والثلاثين": 33,
    "الرابعة والثلاثون": 34, "الرابعة والثلاثين": 34,
    "الخامسة والثلاثون": 35, "الخامسة والثلاثين": 35,
    "السادسة والثلاثون": 36, "السادسة والثلاثين": 36,
    "السابعة والثلاثون": 37, "السابعة والثلاثين": 37,
    "الثامنة والثلاثون": 38, "الثامنة والثلاثين": 38,
    "التاسعة والثلاثون": 39, "التاسعة والثلاثين": 39,
    "الأربعون": 40, "الأربعين": 40,
    "الحادية والأربعون": 41, "الحادية والأربعين": 41,
    "الثانية والأربعون": 42, "الثانية والأربعين": 42,
    "الثالثة والأربعون": 43, "الثالثة والأربعين": 43,
    "الرابعة والأربعون": 44, "الرابعة والأربعين": 44,
    "الخامسة والأربعون": 45, "الخامسة والأربعين": 45,
    "السادسة والأربعون": 46, "السادسة والأربعين": 46,
    "السابعة والأربعون": 47, "السابعة والأربعين": 47,
    "الثامنة والأربعون": 48, "الثامنة والأربعين": 48,
    "التاسعة والأربعون": 49, "التاسعة والأربعين": 49,
    "الخمسون": 50, "الخمسين": 50,
    "الحادية والخمسون": 51, "الحادية والخمسين": 51,
    "الثانية والخمسون": 52, "الثانية والخمسين": 52,
    "الثالثة والخمسون": 53, "الثالثة والخمسين": 53,
    "الرابعة والخمسون": 54, "الرابعة والخمسين": 54,
    "الخامسة والخمسون": 55, "الخامسة والخمسين": 55,
    "السادسة والخمسون": 56, "السادسة والخمسين": 56,
    "السابعة والخمسون": 57, "السابعة والخمسين": 57,
    "الثامنة والخمسون": 58, "الثامنة والخمسين": 58,
    "التاسعة والخمسون": 59, "التاسعة والخمسين": 59,
    "الستون": 60, "الستين": 60,
    "الحادية والستون": 61, "الحادية والستين": 61,
    "الثانية والستون": 62, "الثانية والستين": 62,
    "الثالثة والستون": 63, "الثالثة والستين": 63,
    "الرابعة والستون": 64, "الرابعة والستين": 64,
    "الخامسة والستون": 65, "الخامسة والستين": 65,
    "السادسة والستون": 66, "السادسة والستين": 66,
    "السابعة والستون": 67, "السابعة والستين": 67,
    "الثامنة والستون": 68, "الثامنة والستين": 68,
    "التاسعة والستون": 69, "التاسعة والستين": 69,
    "السبعون": 70, "السبعين": 70,
    "الحادية والسبعون": 71, "الحادية والسبعين": 71,
    "الثانية والسبعون": 72, "الثانية والسبعين": 72,
    "الثالثة والسبعون": 73, "الثالثة والسبعين": 73,
    "الرابعة والسبعون": 74, "الرابعة والسبعين": 74,
    "الخامسة والسبعون": 75, "الخامسة والسبعين": 75,
    "السادسة والسبعون": 76, "السادسة والسبعين": 76,
    "السابعة والسبعون": 77, "السابعة والسبعين": 77,
    "الثامنة والسبعون": 78, "الثامنة والسبعين": 78,
    "التاسعة والسبعون": 79, "التاسعة والسبعين": 79,
    "الثمانون": 80, "الثمانين": 80,
    "الحادية والثمانون": 81, "الحادية والثمانين": 81,
    "الثانية والثمانون": 82, "الثانية والثمانين": 82,
    "الثالثة والثمانون": 83, "الثالثة والثمانين": 83,
    "الرابعة والثمانون": 84, "الرابعة والثمانين": 84,
    "الخامسة والثمانون": 85, "الخامسة والثمانين": 85,
    "السادسة والثمانون": 86, "السادسة والثمانين": 86,
    "السابعة والثمانون": 87, "السابعة والثمانين": 87,
    "الثامنة والثمانون": 88, "الثامنة والثمانين": 88,
    "التاسعة والثمانون": 89, "التاسعة والثمانين": 89,
    "التسعون": 90, "التسعين": 90,
    "الحادية والتسعون": 91, "الحادية والتسعين": 91,
    "الثانية والتسعون": 92, "الثانية والتسعين": 92,
    "الثالثة والتسعون": 93, "الثالثة والتسعين": 93,
    "الرابعة والتسعون": 94, "الرابعة والتسعين": 94,
    "الخامسة والتسعون": 95, "الخامسة والتسعين": 95,
    "السادسة والتسعون": 96, "السادسة والتسعين": 96,
    "السابعة والتسعون": 97, "السابعة والتسعين": 97,
    "الثامنة والتسعون": 98, "الثامنة والتسعين": 98,
    "التاسعة والتسعون": 99, "التاسعة والتسعين": 99,
    "المائة": 100, "المائتين": 200,
}

# Patterns for "المادة X بعد المائة" → 100+X, "المادة X بعد المائتين" → 200+X
ARTICLE_PATTERN = re.compile(
    r'المادة\s+([\u0600-\u06FF\s]+?)(?:\s*\n|$)'
)

def parse_article_number(name_text: str) -> int:
    """Convert Arabic ordinal article name to number."""
    name = name_text.strip()

    # Handle "X بعد المائتين" → 200+X
    m = re.match(r'(.+?)\s+بعد المائتين', name)
    if m:
        base = m.group(1).strip()
        for k, v in ARABIC_ORDINALS.items():
            if k == base:
                return 200 + v
        return -1

    # Handle "X بعد المائة" → 100+X
    m = re.match(r'(.+?)\s+بعد المائة', name)
    if m:
        base = m.group(1).strip()
        for k, v in ARABIC_ORDINALS.items():
            if k == base:
                return 100 + v
        return -1

    # Handle simple ordinals
    for k, v in sorted(ARABIC_ORDINALS.items(), key=lambda x: len(x[0]), reverse=True):
        if name == k:
            return v

    return -1


# Topic mapping: article ranges → topic names (matching ChromaDB topics)
ARTICLE_TOPICS = [
    (1, 5, "الخطبة", "الباب الأول: الزواج", "الفصل الأول: الخطبة"),
    (6, 11, "عقد الزواج", "الباب الأول: الزواج", "الفصل الثاني: أحكام عامة للزواج"),
    (12, 16, "أركان الزواج", "الباب الأول: الزواج", "الفصل الثالث: أركان عقد الزواج وشروطه"),
    (17, 21, "الولاية في الزواج", "الباب الأول: الزواج", "الفصل الثالث: أركان عقد الزواج وشروطه"),
    (22, 26, "المحرمات", "الباب الأول: الزواج", "الفصل الثالث: أركان عقد الزواج وشروطه"),
    (27, 29, "شروط الزواج", "الباب الأول: الزواج", "الفصل الثالث: أركان عقد الزواج وشروطه"),
    (30, 35, "الزواج الباطل والفاسد", "الباب الأول: الزواج", "الفصل الثالث: أركان عقد الزواج وشروطه"),
    (36, 41, "المهر", "الباب الأول: الزواج", "الفصل الثالث: أركان عقد الزواج وشروطه"),
    (42, 43, "حقوق الزوجين", "الباب الأول: الزواج", "الفصل الرابع: حقوق الزوجين"),
    (44, 50, "النفقة", "الباب الثاني: آثار عقد الزواج", "الفصل الأول: النفقة"),
    (51, 57, "النفقة", "الباب الثاني: آثار عقد الزواج", "الفصل الأول: النفقة"),
    (58, 66, "نفقة الأقارب", "الباب الثاني: آثار عقد الزواج", "الفصل الأول: النفقة"),
    (67, 75, "النسب", "الباب الثاني: آثار عقد الزواج", "الفصل الثاني: النسب"),
    (76, 76, "أسباب الفرقة", "الباب الثالث: الفرقة بين الزوجين", "الفصل الأول: أحكام عامة للفرقة"),
    (77, 94, "الطلاق", "الباب الثالث: الفرقة بين الزوجين", "الفصل الثاني: الطلاق"),
    (95, 102, "الخلع", "الباب الثالث: الفرقة بين الزوجين", "الفصل الثالث: الخلع"),
    (103, 115, "فسخ النكاح", "الباب الثالث: الفرقة بين الزوجين", "الفصل الرابع: فسخ عقد الزواج"),
    (116, 123, "العدة", "الباب الرابع: آثار الفرقة بين الزوجين", "الفصل الأول: العدة"),
    (124, 135, "الحضانة", "الباب الرابع: آثار الفرقة بين الزوجين", "الفصل الثاني: الحضانة"),
    (136, 144, "الولاية على القاصر", "الباب الخامس: الوصاية والولاية", "الفصل الأول: أحكام عامة"),
    (145, 151, "الوصاية", "الباب الخامس: الوصاية والولاية", "الفصل الثاني: الوصي"),
    (152, 160, "الولاية على القاصر", "الباب الخامس: الوصاية والولاية", "الفصل الثالث والرابع"),
    (161, 168, "الغائب والمفقود", "الباب الخامس: الوصاية والولاية", "الفصل الخامس: الغائب والمفقود"),
    (169, 172, "الوصية", "الباب السادس: الوصية", "الفصل الأول: أحكام عامة للوصية"),
    (173, 195, "الوصية", "الباب السادس: الوصية", "الفصل الثاني: أركان الوصية وشروطها"),
    (196, 196, "الوصية", "الباب السادس: الوصية", "الفصل الثالث: مبطلات الوصية"),
    (197, 206, "أحكام الإرث", "الباب السابع: التركة والإرث", "الفصل الأول: أحكام عامة"),
    (207, 220, "الإرث بالفرض", "الباب السابع: التركة والإرث", "الفصل الثاني: ميراث أصحاب الفروض"),
    (221, 231, "التعصيب", "الباب السابع: التركة والإرث", "الفصل الثالث: الحجب والتعصيب والعول والرد"),
    (232, 237, "أحكام الإرث", "الباب السابع: التركة والإرث", "الفصل الرابع: ميراث ذوي الأرحام"),
    (238, 242, "أحكام الإرث", "الباب السابع: التركة والإرث", "الفصل الخامس: ميراث المفقود والحمل"),
    (243, 245, "أحكام الإرث", "الباب السابع: التركة والإرث", "الفصل السادس: التخارج في التركة"),
    (246, 252, "أحكام الإرث", "الباب السابع: التركة والإرث", "الباب الثامن: أحكام ختامية"),
]


def get_topic_info(article_num: int):
    for start, end, topic, chapter, section in ARTICLE_TOPICS:
        if start <= article_num <= end:
            return topic, chapter, section
    return "عام", "عام", "عام"


def main():
    with open(RAW_TEXT_PATH, "r", encoding="utf-8") as f:
        raw = f.read()

    # Split by article headers
    # Pattern: "المادة الأولى" or "المادة الثانية بعد المائة" etc.
    parts = re.split(r'\n(المادة\s+[\u0600-\u06FF\s]+?)\n', raw)

    articles = []
    current_article_name = None

    for i, part in enumerate(parts):
        part = part.strip()
        if not part:
            continue

        # Check if this is an article header
        if part.startswith("المادة "):
            current_article_name = part
            continue

        # If we have a current article name, this is the article text
        if current_article_name:
            num = parse_article_number(current_article_name.replace("المادة ", "").strip())
            if num > 0:
                topic, chapter, section = get_topic_info(num)
                articles.append({
                    "article_number": num,
                    "article_name": current_article_name,
                    "text": part.strip(),
                    "topic": topic,
                    "chapter": chapter,
                    "section": section,
                    "law": "نظام الأحوال الشخصية",
                })
            else:
                print(f"WARNING: Could not parse article number: '{current_article_name}'", file=sys.stderr)
            current_article_name = None

    # Sort by article number
    articles.sort(key=lambda a: a["article_number"])

    # Report
    print(f"Parsed {len(articles)} articles from clean text")
    nums = [a["article_number"] for a in articles]
    print(f"Article range: {min(nums)} - {max(nums)}")

    # Check for gaps
    expected = set(range(1, max(nums) + 1))
    found = set(nums)
    missing = expected - found
    if missing:
        print(f"MISSING articles: {sorted(missing)}")
    else:
        print("No gaps — all articles present!")

    # Check for duplicates
    from collections import Counter
    dupes = [n for n, c in Counter(nums).items() if c > 1]
    if dupes:
        print(f"DUPLICATE articles: {dupes}")

    # Compare with existing
    with open(EXISTING_PATH, "r", encoding="utf-8") as f:
        existing = json.load(f)

    existing_articles = existing["articles"] if isinstance(existing, dict) else existing
    existing_ahwal = [a for a in existing_articles if a.get("law") == "نظام الأحوال الشخصية"]
    print(f"\nExisting DB: {len(existing_ahwal)} أحوال شخصية articles")
    print(f"Clean text:  {len(articles)} articles")
    print(f"Difference:  {len(articles) - len(existing_ahwal)} articles")

    # Save clean articles
    with open(OUTPUT_PATH, "w", encoding="utf-8") as f:
        json.dump(articles, f, ensure_ascii=False, indent=2)
    print(f"\nSaved to {OUTPUT_PATH}")

    # Show sample comparison for first 5 articles
    existing_by_num = {a["article_number"]: a for a in existing_ahwal}
    print("\n=== Sample Comparison (first 5 articles) ===")
    for art in articles[:5]:
        num = art["article_number"]
        old = existing_by_num.get(num)
        if old:
            clean_short = art["text"][:80]
            old_short = old["text"][:80]
            match = "MATCH" if art["text"].strip() == old["text"].strip() else "DIFF"
            print(f"\nArticle {num}: {match}")
            print(f"  CLEAN: {clean_short}...")
            print(f"  OLD:   {old_short}...")


if __name__ == "__main__":
    main()
