"""
Add Saudi Procedural Law (نظام المرافعات الشرعية) + its executive regulations to articles.json.
Extracts from PDF text that uses ligature Arabic forms.
"""
import json
import re
import os

# Ligature mapping for PDF text normalization
LIGATURE_MAP = {
    # الـ + حرف ligatures (most common PDF Arabic issue)
    'املادة': 'المادة', 'املحاكم': 'المحاكم', 'املحكمة': 'المحكمة',
    'املدعي': 'المدعي', 'املدعى': 'المدعى', 'املرافعات': 'المرافعات',
    'املوضوع': 'الموضوع', 'امللف': 'الملف', 'املقر': 'المقر',
    'املختصة': 'المختصة', 'املتعلقة': 'المتعلقة', 'املعاهدات': 'المعاهدات',
    'املائة': 'المائة', 'املائتني': 'المائتين', 'املذكورة': 'المذكورة',
    'املسائل': 'المسائل', 'املستعجلة': 'المستعجلة', 'املوظفني': 'الموظفين',
    # اجل ligatures
    'اجللسة': 'الجلسة', 'اجللسات': 'الجلسات', 'اجلمعية': 'الجمعية',
    'اجلهات': 'الجهات', 'اجلهة': 'الجهة', 'اجلهاز': 'الجهاز',
    # احل ligatures
    'احلادية': 'الحادية', 'احلق': 'الحق', 'احلكم': 'الحكم',
    'احلمد': 'الحمد', 'احلكومية': 'الحكومية', 'احلاجة': 'الحاجة',
    'احلكومي': 'الحكومي', 'احلال': 'الحال', 'احلاالت': 'الحالات',
    # اخل ligatures
    'اخلصوم': 'الخصوم', 'اخلامسة': 'الخامسة', 'اخلاصة': 'الخاصة',
    'اخلربة': 'الخبرة', 'اخلمسون': 'الخمسون', 'اخلصومة': 'الخصومة',
    # اإل ligatures
    'اإلسامية': 'الإسلامية', 'اإلجراء': 'الإجراء', 'اإللكرتونية': 'الإلكترونية',
    'اإلجراءات': 'الإجراءات', 'اإلنهاءات': 'الإنهاءات',
    # اهل ligatures
    'اهلجري': 'الهجري',
    # Other common ligatures
    'األوىل': 'الأولى', 'األحكام': 'الأحكام', 'األول': 'الأول',
    'األربعون': 'الأربعون', 'األجهزة': 'الأجهزة', 'األخرى': 'الأخرى',
    'العارشة': 'العاشرة', 'امليادي': 'الميلادي',
    'الريعة': 'الشريعة', 'الرطة': 'الشرطة', 'الرهر': 'الشهر',
    # Common word-level ligatures in PDF
    'يف': 'في', 'عىل': 'على', 'إىل': 'إلى',
    'جيوز': 'يجوز', 'جيب': 'يجب',
    'هبا': 'بها', 'هبم': 'بهم', 'هبذا': 'بهذا',
    'هلا': 'لها', 'هلم': 'لهم',
    'حممد': 'محمد', 'حمر': 'محضر',
    'برشط': 'بشرط',
    'ويل': 'ولي',
    'ختلف': 'يختلف',
    'حتسب': 'تحسب', 'حتديد': 'تحديد', 'حتقق': 'تحقق',
    'تري': 'تجري', 'حيرر': 'يحرر', 'جيري': 'يجري',
    'القايض': 'القاضي', 'القضايا': 'القضايا',
    'خمترص': 'مختصر', 'خمتص': 'مختص', 'خمتصة': 'مختصة',
    'الالئحة': 'اللائحة', 'الائحة': 'اللائحة',
    'بأزواجهم': 'بأزواجهم',
    'حتى': 'حتى',  # this one is correct already
    'الدعاوى': 'الدعاوى',  # correct
    'خيشى': 'يخشى',
    'خيصهم': 'يخصهم',
    'غرهم': 'غيرهم', 'غر': 'غير',
    'كاتب': 'كاتب',  # correct
    'واليتها': 'ولايتها', 'والية': 'ولاية',
    'حمر': 'محضر',
    'نيابة': 'نيابة',  # correct
    'بعـد': 'بعد',
    'قبـل': 'قبل',
    # Remove tatweel/kashida
}


def normalize_text(text):
    """Normalize PDF ligature text to standard Arabic."""
    # Remove tatweel (kashida) character
    text = text.replace('\u0640', '')
    # Remove zero-width characters
    text = text.replace('\u200b', '').replace('\u200c', '').replace('\u200d', '')
    # Apply ligature replacements (longer strings first to avoid partial matches)
    sorted_items = sorted(LIGATURE_MAP.items(), key=lambda x: len(x[0]), reverse=True)
    for old, new in sorted_items:
        text = text.replace(old, new)
    # Remove excessive whitespace within words caused by PDF extraction
    text = re.sub(r'(\w)\s{2,}(\w)', r'\1 \2', text)
    # Clean up multiple spaces
    text = re.sub(r' {2,}', ' ', text)
    # Remove page numbers that appear alone on lines
    text = re.sub(r'\n\d{1,3}\n', '\n', text)
    # Remove الفهرس markers
    text = re.sub(r'\nالفهرس\n', '\n', text)
    return text.strip()


# Ordinal to number mapping for PDF ligature forms
ORDINAL_MAP = {
    'األوىل': 1, 'الأولى': 1,
    'الثانية': 2,
    'الثالثة': 3,
    'الرابعة': 4,
    'اخلامسة': 5, 'الخامسة': 5,
    'السادسة': 6,
    'السابعة': 7,
    'الثامنة': 8,
    'التاسعة': 9,
    'العارشة': 10, 'العاشرة': 10,
    'احلادية عرشة': 11, 'الحادية عشرة': 11,
    'الثانية عرشة': 12, 'الثانية عشرة': 12,
    'الثالثة عرشة': 13, 'الثالثة عشرة': 13,
    'الرابعة عرشة': 14, 'الرابعة عشرة': 14,
    'اخلامسة عرشة': 15, 'الخامسة عشرة': 15,
    'السادسة عرشة': 16, 'السادسة عشرة': 16,
    'السابعة عرشة': 17, 'السابعة عشرة': 17,
    'الثامنة عرشة': 18, 'الثامنة عشرة': 18,
    'التاسعة عرشة': 19, 'التاسعة عشرة': 19,
    'العرشون': 20, 'العشرون': 20,
    'احلادية والعرشون': 21, 'الحادية والعشرون': 21,
    'الثانية والعرشون': 22, 'الثانية والعشرون': 22,
    'الثالثة والعرشون': 23, 'الثالثة والعشرون': 23,
    'الرابعة والعرشون': 24, 'الرابعة والعشرون': 24,
    'اخلامسة والعرشون': 25, 'الخامسة والعشرون': 25,
    'السادسة والعرشون': 26, 'السادسة والعشرون': 26,
    'السابعة والعرشون': 27, 'السابعة والعشرون': 27,
    'الثامنة والعرشون': 28, 'الثامنة والعشرون': 28,
    'التاسعة والعرشون': 29, 'التاسعة والعشرون': 29,
    'الثالثون': 30,
    'احلادية والثالثون': 31, 'الحادية والثلاثون': 31,
    'الثانية والثالثون': 32, 'الثانية والثلاثون': 32,
    'الثالثة والثالثون': 33, 'الثالثة والثلاثون': 33,
    'الرابعة والثالثون': 34, 'الرابعة والثلاثون': 34,
    'اخلامسة والثالثون': 35, 'الخامسة والثلاثون': 35,
    'السادسة والثالثون': 36, 'السادسة والثلاثون': 36,
    'السابعة والثالثون': 37, 'السابعة والثلاثون': 37,
    'الثامنة والثالثون': 38, 'الثامنة والثلاثون': 38,
    'التاسعة والثالثون': 39, 'التاسعة والثلاثون': 39,
    'األربعون': 40, 'الأربعون': 40,
    'احلادية واألربعون': 41, 'الحادية والأربعون': 41,
    'الثانية واألربعون': 42, 'الثانية والأربعون': 42,
    'الثالثة واألربعون': 43, 'الثالثة والأربعون': 43,
    'الرابعة واألربعون': 44, 'الرابعة والأربعون': 44,
    'اخلامسة واألربعون': 45, 'الخامسة والأربعون': 45,
    'السادسة واألربعون': 46, 'السادسة والأربعون': 46,
    'السابعة واألربعون': 47, 'السابعة والأربعون': 47,
    'الثامنة واألربعون': 48, 'الثامنة والأربعون': 48,
    'التاسعة واألربعون': 49, 'التاسعة والأربعون': 49,
    'اخلمسون': 50, 'الخمسون': 50,
    'احلادية واخلمسون': 51, 'الحادية والخمسون': 51,
    'الثانية واخلمسون': 52, 'الثانية والخمسون': 52,
    'الثالثة واخلمسون': 53, 'الثالثة والخمسون': 53,
    'الرابعة واخلمسون': 54, 'الرابعة والخمسون': 54,
    'اخلامسة واخلمسون': 55, 'الخامسة والخمسون': 55,
    'السادسة واخلمسون': 56, 'السادسة والخمسون': 56,
    'السابعة واخلمسون': 57, 'السابعة والخمسون': 57,
    'الثامنة واخلمسون': 58, 'الثامنة والخمسون': 58,
    'التاسعة واخلمسون': 59, 'التاسعة والخمسون': 59,
    'الستون': 60,
    'احلادية والستون': 61, 'الحادية والستون': 61,
    'الثانية والستون': 62,
    'الثالثة والستون': 63,
    'الرابعة والستون': 64,
    'اخلامسة والستون': 65, 'الخامسة والستون': 65,
    'السادسة والستون': 66,
    'السابعة والستون': 67,
    'الثامنة والستون': 68,
    'التاسعة والستون': 69,
    'السبعون': 70,
    'احلادية والسبعون': 71, 'الحادية والسبعون': 71,
    'الثانية والسبعون': 72,
    'الثالثة والسبعون': 73,
    'الرابعة والسبعون': 74,
    'اخلامسة والسبعون': 75, 'الخامسة والسبعون': 75,
    'السادسة والسبعون': 76,
    'السابعة والسبعون': 77,
    'الثامنة والسبعون': 78,
    'التاسعة والسبعون': 79,
    'الثامنون': 80, 'الثمانون': 80,
    'احلادية والثامنون': 81, 'الحادية والثمانون': 81,
    'الثانية والثامنون': 82, 'الثانية والثمانون': 82,
    'الثالثة والثامنون': 83, 'الثالثة والثمانون': 83,
    'الرابعة والثامنون': 84, 'الرابعة والثمانون': 84,
    'اخلامسة والثامنون': 85, 'الخامسة والثمانون': 85,
    'السادسة والثامنون': 86, 'السادسة والثمانون': 86,
    'السابعة والثامنون': 87, 'السابعة والثمانون': 87,
    'الثامنة والثامنون': 88, 'الثامنة والثمانون': 88,
    'التاسعة والثامنون': 89, 'التاسعة والثمانون': 89,
    'التسعون': 90,
    'احلادية والتسعون': 91, 'الحادية والتسعون': 91,
    'الثانية والتسعون': 92,
    'الثالثة والتسعون': 93,
    'الرابعة والتسعون': 94,
    'اخلامسة والتسعون': 95, 'الخامسة والتسعون': 95,
    'السادسة والتسعون': 96,
    'السابعة والتسعون': 97,
    'الثامنة والتسعون': 98,
    'التاسعة والتسعون': 99,
    'املائة': 100, 'المائة': 100,
    'احلادية بعد املائة': 101, 'األوىل بعد املائة': 101,
    'الثانية بعد املائة': 102,
    'الثالثة بعد املائة': 103,
    'الرابعة بعد املائة': 104,
    'اخلامسة بعد املائة': 105,
    'السادسة بعد املائة': 106,
    'السابعة بعد املائة': 107,
    'الثامنة بعد املائة': 108,
    'التاسعة بعد املائة': 109,
    'العارشة بعد املائة': 110,
    'احلادية عرشة بعد املائة': 111,
    'الثانية عرشة بعد املائة': 112,
    'الثالثة عرشة بعد املائة': 113,
    'الرابعة عرشة بعد املائة': 114,
    'اخلامسة عرشة بعد املائة': 115,
    'السادسة عرشة بعد املائة': 116,
    'السابعة عرشة بعد املائة': 117,
    'الثامنة عرشة بعد املائة': 118,
    'التاسعة عرشة بعد املائة': 119,
    'العرشون بعد املائة': 120, 'العشرون بعد المائة': 120,
    'احلادية والعرشون بعد املائة': 121,
    'الثانية والعرشون بعد املائة': 122,
    'الثالثة والعرشون بعد املائة': 123,
    'الرابعة والعرشون بعد املائة': 124,
    'اخلامسة والعرشون بعد املائة': 125,
    'السادسة والعرشون بعد املائة': 126,
    'السابعة والعرشون بعد املائة': 127,
    'الثامنة والعرشون بعد املائة': 128,
    'التاسعة والعرشون بعد املائة': 129,
    'الثالثون بعد املائة': 130,
    'احلادية والثالثون بعد املائة': 131,
    'الثانية والثالثون بعد املائة': 132,
    'الثالثة والثالثون بعد املائة': 133,
    'الرابعة والثالثون بعد املائة': 134,
    'اخلامسة والثالثون بعد املائة': 135,
    'السادسة والثالثون بعد املائة': 136,
    'السابعة والثالثون بعد املائة': 137,
    'الثامنة والثالثون بعد املائة': 138,
    'التاسعة والثالثون بعد املائة': 139,
    'األربعون بعد املائة': 140,
    'احلادية واألربعون بعد املائة': 141,
    'الثانية واألربعون بعد املائة': 142,
    'الثالثة واألربعون بعد املائة': 143,
    'الرابعة واألربعون بعد املائة': 144,
    'اخلامسة واألربعون بعد املائة': 145,
    'السادسة واألربعون بعد املائة': 146,
    'السابعة واألربعون بعد املائة': 147,
    'الثامنة واألربعون بعد املائة': 148,
    'التاسعة واألربعون بعد املائة': 149,
    'اخلمسون بعد املائة': 150,
    'احلادية واخلمسون بعد املائة': 151,
    'الثانية واخلمسون بعد املائة': 152,
    'الثالثة واخلمسون بعد املائة': 153,
    'الرابعة واخلمسون بعد املائة': 154,
    'اخلامسة واخلمسون بعد املائة': 155,
    'السادسة واخلمسون بعد املائة': 156,
    'السابعة واخلمسون بعد املائة': 157,
    'الثامنة واخلمسون بعد املائة': 158,
    'التاسعة واخلمسون بعد املائة': 159,
    'الستون بعد املائة': 160,
    'احلادية والستون بعد املائة': 161,
    'الثانية والستون بعد املائة': 162,
    'الثالثة والستون بعد املائة': 163,
    'الرابعة والستون بعد املائة': 164,
    'اخلامسة والستون بعد املائة': 165,
    'السادسة والستون بعد املائة': 166,
    'السابعة والستون بعد املائة': 167,
    'الثامنة والستون بعد املائة': 168,
    'التاسعة والستون بعد املائة': 169,
    'السبعون بعد املائة': 170,
    'احلادية والسبعون بعد املائة': 171,
    'الثانية والسبعون بعد املائة': 172,
    'الثالثة والسبعون بعد املائة': 173,
    'الرابعة والسبعون بعد املائة': 174,
    'اخلامسة والسبعون بعد املائة': 175,
    'السادسة والسبعون بعد املائة': 176,
    'السابعة والسبعون بعد املائة': 177,
    'الثامنة والسبعون بعد املائة': 178,
    'التاسعة والسبعون بعد املائة': 179,
    'الثامنون بعد املائة': 180,
    'احلادية والثامنون بعد املائة': 181,
    'الثانية والثامنون بعد املائة': 182,
    'الثالثة والثامنون بعد املائة': 183,
    'الرابعة والثامنون بعد املائة': 184,
    'اخلامسة والثامنون بعد املائة': 185,
    'السادسة والثامنون بعد املائة': 186,
    'السابعة والثامنون بعد املائة': 187,
    'الثامنة والثامنون بعد املائة': 188,
    'التاسعة والثامنون بعد املائة': 189,
    'التسعون بعد املائة': 190,
    'احلادية والتسعون بعد املائة': 191,
    'الثانية والتسعون بعد املائة': 192,
    'الثالثة والتسعون بعد املائة': 193,
    'الرابعة والتسعون بعد املائة': 194,
    'اخلامسة والتسعون بعد املائة': 195,
    'السادسة والتسعون بعد املائة': 196,
    'السابعة والتسعون بعد املائة': 197,
    'الثامنة والتسعون بعد املائة': 198,
    'التاسعة والتسعون بعد املائة': 199,
    'املائتان': 200, 'المائتان': 200,
    'احلادية بعد املائتني': 201,
    'الثانية بعد املائتني': 202,
    'الثالثة بعد املائتني': 203,
    'الرابعة بعد املائتني': 204,
    'اخلامسة بعد املائتني': 205,
    'السادسة بعد املائتني': 206,
    'السابعة بعد املائتني': 207,
    'الثامنة بعد املائتني': 208,
    'التاسعة بعد املائتني': 209,
    'العارشة بعد املائتني': 210,
    'احلادية عرشة بعد املائتني': 211,
    'الثانية عرشة بعد املائتني': 212,
    'الثالثة عرشة بعد املائتني': 213,
    'الرابعة عرشة بعد املائتني': 214,
    'اخلامسة عرشة بعد املائتني': 215,
    'السادسة عرشة بعد املائتني': 216,
    'السابعة عرشة بعد املائتني': 217,
    'الثامنة عرشة بعد املائتني': 218,
    'التاسعة عرشة بعد املائتني': 219,
    'العرشون بعد املائتني': 220,
    'احلادية والعرشون بعد املائتني': 221,
    'الثانية والعرشون بعد املائتني': 222,
    'الثالثة والعرشون بعد املائتني': 223,
    'الرابعة والعرشون بعد املائتني': 224,
    'اخلامسة والعرشون بعد املائتني': 225,
    'السادسة والعرشون بعد املائتني': 226,
    'السابعة والعرشون بعد املائتني': 227,
    'الثامنة والعرشون بعد املائتني': 228,
    'التاسعة والعرشون بعد املائتني': 229,
    'الثالثون بعد املائتني': 230,
    'احلادية والثالثون بعد املائتني': 231,
    'الثانية والثالثون بعد املائتني': 232,
    'الثالثة والثالثون بعد املائتني': 233,
    'الرابعة والثالثون بعد املائتني': 234,
    'اخلامسة والثالثون بعد املائتني': 235,
    'السادسة والثالثون بعد املائتني': 236,
    'السابعة والثالثون بعد املائتني': 237,
    'الثامنة والثالثون بعد املائتني': 238,
    'التاسعة والثالثون بعد املائتني': 239,
    'األربعون بعد املائتني': 240,
    'احلادية واألربعون بعد املائتني': 241,
    'الثانية واألربعون بعد املائتني': 242,
}

# Article ranges → topic mapping
ARTICLE_MAP = [
    (1, 9, "الباب الأول - أحكام عامة", "أحكام عامة", "مرافعات - أحكام عامة", ["مرافعات", "أحكام عامة"]),
    (10, 27, "الباب الثاني - الاختصاص", "الاختصاص", "اختصاص المحاكم", ["مرافعات", "اختصاص"]),
    (28, 36, "الباب الثاني - الاختصاص", "الاختصاص المكاني", "اختصاص مكاني", ["مرافعات", "اختصاص مكاني"]),
    (37, 46, "الباب الثالث - رفع الدعوى وقيدها", "رفع الدعوى", "رفع الدعوى", ["مرافعات", "رفع دعوى", "قيد"]),
    (47, 56, "الباب الرابع - حضور الخصوم وغيابهم", "حضور وغياب", "حضور الخصوم", ["مرافعات", "حضور", "غياب"]),
    (57, 67, "الباب الخامس - إجراءات الجلسات ونظامها", "إجراءات الجلسات", "إجراءات الجلسات", ["مرافعات", "جلسات"]),
    (68, 75, "الباب السادس - الدفوع والإدخال والتدخل والطلبات العارضة", "الدفوع والتدخل", "دفوع وتدخل", ["مرافعات", "دفوع", "تدخل"]),
    (76, 83, "الباب السابع - وقف الخصومة وانقطاعها وتركها", "وقف الخصومة", "وقف الخصومة", ["مرافعات", "وقف", "انقطاع", "ترك"]),
    (84, 92, "الباب الثامن - تنحي القضاة وردهم عن الحكم", "تنحي القضاة", "تنحي وردّ القضاة", ["مرافعات", "تنحي", "رد قاضي"]),
    (93, 109, "الباب التاسع - إجراءات الإثبات", "إجراءات الإثبات", "إثبات في المرافعات", ["مرافعات", "إثبات"]),
    (110, 127, "الباب العاشر - الأحكام", "الأحكام", "إصدار الأحكام", ["مرافعات", "أحكام", "حكم"]),
    (128, 145, "الباب الحادي عشر - طرق الاعتراض على الأحكام", "طرق الاعتراض", "اعتراض واستئناف", ["مرافعات", "اعتراض", "استئناف", "نقض"]),
    (146, 158, "الباب الحادي عشر - طرق الاعتراض", "النقض والتماس إعادة النظر", "نقض والتماس", ["مرافعات", "نقض", "التماس إعادة النظر"]),
    (159, 175, "الباب الثاني عشر - القضاء المستعجل", "القضاء المستعجل", "قضاء مستعجل", ["مرافعات", "مستعجل"]),
    (176, 190, "الباب الثالث عشر - الإنهاءات", "الإنهاءات", "إنهاءات", ["مرافعات", "إنهاءات"]),
    (191, 210, "الباب الرابع عشر - أحكام عامة وختامية", "أحكام ختامية", "مرافعات - أحكام ختامية", ["مرافعات", "أحكام ختامية"]),
    (211, 242, "الباب الرابع عشر - أحكام عامة وختامية", "أحكام ختامية", "مرافعات - أحكام ختامية", ["مرافعات", "أحكام ختامية"]),
]


def get_article_metadata(num):
    """Get chapter/section/topic for article number."""
    for start, end, chapter, section, topic, tags in ARTICLE_MAP:
        if start <= num <= end:
            return chapter, section, topic, tags
    return "غير محدد", "غير محدد", "مرافعات", ["مرافعات"]


def parse_articles_from_pdf():
    """Parse law articles from the PDF-extracted text."""
    raw_path = os.path.join(os.path.dirname(__file__), "morafaat_raw.txt")
    with open(raw_path, "r", encoding="utf-8") as f:
        text = f.read()

    articles = {}

    # Strategy: Split text by article headers
    # The PDF uses patterns like:
    # 'لاملادة الأولى 4/29\n' or 'املادة الثانية:\n'
    # Articles include their لائحة (regulation) text

    # Pattern to match article headers
    # Matches: 'املادة [ordinal]' with any prefix (لا, ل, نا, وا, عا, etc.)
    # and optional trailing references (page numbers, etc.)
    article_pattern = re.compile(
        r'(?:[:\s]*)(?:[\u0600-\u06FF]*)املادة\s+([^\n]{3,80}?)\s*\n',
    )

    matches = list(article_pattern.finditer(text))
    print(f"Found {len(matches)} article header matches")

    for i, match in enumerate(matches):
        ordinal_text = match.group(1).strip()
        # Clean up the ordinal: remove trailing references, numbers, colons
        ordinal_text = re.sub(r'\s*\d+/\s*\d+', '', ordinal_text).strip()  # Remove X/Y refs
        ordinal_text = re.sub(r'[\s:]+[\d/\sلنعو]+$', '', ordinal_text).strip()  # Remove trailing nums
        ordinal_text = re.sub(r'\s*[:\s]+$', '', ordinal_text).strip()  # Remove trailing colons

        num = ORDINAL_MAP.get(ordinal_text)
        if num is None:
            continue

        start = match.start()
        # End is the start of next article or end of text
        if i + 1 < len(matches):
            end = matches[i + 1].start()
        else:
            end = min(start + 5000, len(text))

        article_text = text[start:end].strip()
        # Limit article text to reasonable size
        if len(article_text) > 3000:
            article_text = article_text[:3000]

        # Normalize the text
        article_text = normalize_text(article_text)

        # Only keep if not already found or this one is longer
        if num not in articles or len(article_text) > len(articles[num]):
            articles[num] = article_text

    return articles


def main():
    json_path = os.path.join(os.path.dirname(__file__), "articles.json")

    # Read existing data
    with open(json_path, "r", encoding="utf-8") as f:
        data = json.load(f)

    existing_count = data["total_chunks"]
    print(f"Existing articles: {existing_count}")

    # Parse morafaat law
    articles = parse_articles_from_pdf()
    sorted_nums = sorted(articles.keys())
    print(f"Parsed {len(articles)} unique morafaat articles")
    print(f"Article numbers: {sorted_nums[:10]}...{sorted_nums[-5:]}")

    # Create new chunks
    new_chunks = []
    for idx, num in enumerate(sorted_nums):
        chapter, section, topic, tags = get_article_metadata(num)
        chunk = {
            "id": f"morafaat_chunk_{num}",
            "chunk_index": existing_count + idx,
            "text": articles[num],
            "chapter": f"نظام المرافعات الشرعية - {chapter}",
            "section": section,
            "topic": topic,
            "topic_tags": tags,
            "has_deadline": any(w in articles[num] for w in ["يوم", "يوماً", "شهر", "مهلة", "خلال", "مدة"]),
            "deadline_details": "",
            "source_pages": "نظام المرافعات الشرعية - م/1 - 1435هـ",
        }
        new_chunks.append(chunk)

    # Append to existing articles
    data["articles"].extend(new_chunks)
    data["total_chunks"] = existing_count + len(new_chunks)

    # Update structure
    data["structure"]["نظام المرافعات الشرعية"] = {
        "الباب الأول": "أحكام عامة",
        "الباب الثاني": "الاختصاص",
        "الباب الثالث": "رفع الدعوى وقيدها",
        "الباب الرابع": "حضور الخصوم وغيابهم",
        "الباب الخامس": "إجراءات الجلسات ونظامها",
        "الباب السادس": "الدفوع والإدخال والتدخل والطلبات العارضة",
        "الباب السابع": "وقف الخصومة وانقطاعها وتركها",
        "الباب الثامن": "تنحي القضاة وردهم عن الحكم",
        "الباب التاسع": "إجراءات الإثبات",
        "الباب العاشر": "الأحكام",
        "الباب الحادي عشر": "طرق الاعتراض على الأحكام",
        "الباب الثاني عشر": "القضاء المستعجل",
        "الباب الثالث عشر": "الإنهاءات",
        "الباب الرابع عشر": "أحكام عامة وختامية",
    }

    # Write updated data
    with open(json_path, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

    print(f"\nUpdated articles.json: {data['total_chunks']} total chunks")
    print(f"Added {len(new_chunks)} morafaat law articles")


if __name__ == "__main__":
    main()
